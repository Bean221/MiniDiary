<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Trang cá nhân</title>
    <link rel="stylesheet" th:href="@{/css/profile.css}" />
</head>
<body>
<div class="profile-container">
    <img th:src="@{'https://i.pravatar.cc/110?u=' + ${user.username}}" alt="avatar" class="profile-avatar" />
    <div class="profile-info">
        <div class="username" th:text="${user.username}">Tên đăng nhập</div>
        <div class="role"><i class="fa-solid fa-user"></i> <span th:text="${user.role}"></span></div>
        <div class="created"><i class="fa-solid fa-calendar"></i> <span th:text="${#dates.format(user.createdAt, 'dd/MM/yyyy HH:mm')}"></span></div>
    </div>
    <div th:if="${user.id} == ${session.user.id}" class="profile-stats">
        <div class="profile-stat">
            <span class="stat-number" th:text="${totalFollowing}">0</span><br>
            <span class="stat-label" id="followingToggle" style="cursor:pointer;">Đang theo dõi</span>
        </div>
        <div class="profile-stat">
            <span class="stat-number" th:text="${#lists.size(posts)}">0</span><br>
            <span class="stat-label">Bài viết</span>
        </div>
    </div>
    <div th:if="${user.id} == ${session.user.id}" id="followingList" class="profile-following-list" style="display:none;">
        <div th:if="${#lists.isEmpty(followingUsers)}" style="color:#888;">Bạn chưa theo dõi ai.</div>
        <div th:each="u : ${followingUsers}" class="following-user">
            <a th:href="@{'/profile/' + ${u.username}}" class="username" style="display:flex; align-items:center;">
                <img th:src="@{'https://i.pravatar.cc/32?u=' + ${u.username}}" class="avatar" />
                <span th:text="${u.username}"></span>
            </a>
            <form th:action="@{/unfollow}" method="post" style="display:inline;">
                <input type="hidden" name="userId" th:value="${u.id}" />
                <button type="submit" class="unfollow-btn">Bỏ follow</button>
            </form>
        </div>
    </div>
    <div style="margin: 32px 0 0 0; width:100%;">
        <div class="profile-posts-title">Nhật ký cá nhân</div>
        <div th:if="${#lists.isEmpty(posts)}" style="text-align:center; color:#888;">Chưa có bài viết nào.</div>
        <div class="profile-posts-grid">
            <div th:each="post : ${posts}" class="profile-post-card">
                <div class="profile-post-title" th:text="${post.title}">Tiêu đề</div>
                <div class="profile-post-body" th:text="${post.body}">Nội dung</div>
                <div class="profile-post-meta">Thời gian: <span th:text="${#dates.format(post.createdAt, 'dd/MM/yyyy HH:mm')}"></span></div>
                <div class="profile-post-meta">Trạng thái: <span th:text="${post.status}"></span></div>
                <th:block th:if="${user.id} == ${session.user.id}">
                    <button type="button" onclick="showEditForm(this)" class="edit-btn">Sửa</button>
                    <form th:action="@{/profile/deletePost}" method="post" style="display:inline; position:absolute; top:12px; right:12px;">
                        <input type="hidden" name="postId" th:value="${post.id}" />
                        <button type="submit" class="delete-btn">Xóa</button>
                    </form>
                    <form th:action="@{/profile/editPost}" method="post" class="edit-form" style="display:none; margin-top:10px; background:#fff; border-radius:8px; padding:10px; box-shadow:0 1px 4px rgba(80,112,255,0.08);">
                        <input type="hidden" name="postId" th:value="${post.id}" />
                        <input type="text" name="title" th:value="${post.title}" required style="width:100%; margin-bottom:6px; padding:6px; border-radius:6px; border:1px solid #dcdde1;" />
                        <textarea name="body" required style="width:100%; margin-bottom:6px; padding:6px; border-radius:6px; border:1px solid #dcdde1;">[[${post.body}]]</textarea>
                        <select name="status" style="width:100%; margin-bottom:6px; padding:6px; border-radius:6px; border:1px solid #dcdde1;">
                            <option value="public" th:selected="${post.status} == 'public'">Công khai</option>
                            <option value="private" th:selected="${post.status} == 'private'">Riêng tư</option>
                            <option value="friends" th:selected="${post.status} == 'friends'">Bạn bè</option>
                        </select>
                        <button type="submit" style="background:#27ae60; color:#fff; border:none; border-radius:6px; padding:4px 14px; cursor:pointer;">Lưu</button>
                        <button type="button" onclick="hideEditForm(this)" style="background:#888; color:#fff; border:none; border-radius:6px; padding:4px 10px; margin-left:6px; cursor:pointer;">Hủy</button>
                    </form>
                </th:block>
            </div>
        </div>
    </div>
    <a th:href="@{/feed}" class="login-link" style="margin-top:18px; color:#4f8cff; text-decoration:none; font-weight:500;">Quay lại trang chủ</a>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var toggle = document.getElementById('followingToggle');
    var list = document.getElementById('followingList');
    if(toggle && list) {
        toggle.onclick = function() {
            list.style.display = (list.style.display === 'none' || list.style.display === '') ? 'block' : 'none';
        }
    }
});
function showEditForm(btn) {
    var form = btn.parentElement.querySelector('.edit-form');
    if(form) form.style.display = 'block';
    btn.style.display = 'none';
}
function hideEditForm(btn) {
    var form = btn.closest('.edit-form');
    if(form) form.style.display = 'none';
    var editBtn = form.parentElement.querySelector('button[type=button]');
    if(editBtn) editBtn.style.display = 'inline-block';
}
</script>
</body>
</html>